<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sleep Check-in</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#111827" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans", "PingFang SC",
          "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        margin: 0;
        background: #0b1020;
        color: #e5e7eb;
      }
      header {
        padding: 16px;
        background: #111827;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      main {
        padding: 16px;
        max-width: 900px;
        margin: 0 auto;
      }
      .card {
        background: #111827;
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 12px;
        margin: 12px 0;
      }
      button {
        background: #2563eb;
        color: white;
        border: 0;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
        margin: 6px 6px 6px 0;
        cursor: pointer;
      }
      button.secondary {
        background: #374151;
      }
      button.danger {
        background: #b91c1c;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #374151;
        background: #0b1020;
        color: #e5e7eb;
      }
      a {
        color: #93c5fd;
        text-decoration: none;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0b1020;
        color: #e5e7eb;
        border: 1px solid #1f2937;
        padding: 10px;
        border-radius: 10px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .muted {
        color: #9ca3af;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border: 1px solid #374151;
        border-radius: 999px;
        font-size: 12px;
        color: #d1d5db;
      }

      details {
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 10px 12px;
        background: #0b1020;
      }
      details > summary {
        cursor: pointer;
        user-select: none;
        font-weight: 700;
        color: #e5e7eb;
      }

      .help {
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px dashed #374151;
        border-radius: 12px;
        background: #0b1020;
      }
      .help ul {
        margin: 8px 0 0 18px;
        padding: 0;
      }
      .help li {
        margin: 6px 0;
        line-height: 1.35;
      }
      code {
        background: #0b1020;
        border: 1px solid #1f2937;
        padding: 0 6px;
        border-radius: 8px;
      }

      table.lb {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 14px;
      }
      table.lb th,
      table.lb td {
        border-bottom: 1px solid #1f2937;
        padding: 8px 6px;
        text-align: left;
        vertical-align: top;
      }
      table.lb th {
        color: #d1d5db;
        font-weight: 700;
      }
      .lb-title {
        font-weight: 700;
      }
      .lb-sub {
        color: #9ca3af;
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <div style="font-weight: 700">Sleep Check-in</div>
        <div class="pill" id="repoPill"></div>
        <div style="margin-left: auto" class="muted" id="authState">Not logged in</div>
      </div>
    </header>

    <main>
      <!-- Leaderboard (yesterday) -->
      <div class="card" id="leaderboardCard">
        <div class="row">
          <div class="lb-title" id="lbTitle">昨日榜单</div>
          <div class="muted" id="lbMeta"></div>
          <div style="margin-left: auto">
            <button id="lbRefreshBtn" class="secondary">Refresh</button>
          </div>
        </div>

        <div class="muted" style="margin-top: 8px">
          统计口径：只统计完整记录（同时有 Sleep/Wake/Duration）；日期边界使用 cutoff=04:00 (UTC+8)；仅统计有 open 的
          <code>sleep-log</code> issue 的用户。
        </div>

        <div id="lbBody" style="margin-top: 10px" class="muted">Loading…</div>
      </div>

      <div class="card" id="setupCard">
        <div style="font-weight: 700; margin-bottom: 8px">设置</div>
        <div class="muted" style="margin-bottom: 10px">
          这是一个 PWA（可添加到主屏幕）。登录后可一键在你的 sleep-log issue 下发表评论命令：
          <code>/sleep</code> <code>/wake</code> <code>/sleep … backfill</code> <code>/wake … backfill</code>
          <code>/undo</code> <code>/archive</code> <code>/rebuild</code>，并查看 bot 回复与表格。
        </div>

        <details>
          <summary>高级设置（一般不需要）</summary>
          <div style="margin-top: 10px">
            <div style="margin-bottom: 8px">Worker Base URL（在 docs/config.js 里配置）</div>
            <input id="workerUrl" readonly />
            <div class="muted" style="margin-top: 8px">
              这个地址用于登录和调用后端 API。只有你更换 Worker 地址时才需要改 docs/config.js。
            </div>
          </div>
        </details>

        <div style="margin-top: 10px">
          <button id="loginBtn">Login with GitHub</button>
          <button id="logoutBtn" class="secondary">Logout</button>
        </div>
        <div class="muted" id="loginHint" style="margin-top: 8px"></div>
      </div>

      <div class="card" id="issueCard" style="display: none">
        <div class="row">
          <div style="font-weight: 700">你的 Sleep Log Issue</div>
          <div class="muted" id="issueStatus"></div>
        </div>
        <div style="margin-top: 8px">
          <div id="issueLink"></div>
        </div>

        <div id="noIssueActions" style="display: none; margin-top: 10px">
          <button id="createIssueBtn" class="secondary">Create Issue</button>
          <div class="muted" style="margin-top: 8px">
            说明：将自动创建一个新的 Sleep Log Issue，并自动发送 <code>/rebuild</code> 来启用机器人与表格（通常 1~2 秒内会更新）。
          </div>
        </div>

        <div id="hasIssueActions" style="display: none; margin-top: 10px">
          <button data-cmd="/sleep">Sleep</button>
          <button data-cmd="/wake">Wake</button>
          <button data-cmd="/undo" class="danger">Undo</button>
          <button data-cmd="/archive" class="secondary">Archive</button>

          <button data-cmd="/rebuild" class="secondary">Rebuild</button>

          <button id="backfillSleepBtn" class="secondary">Backfill Sleep…</button>
          <button id="backfillWakeBtn" class="secondary">Backfill Wake…</button>

          <button id="refreshBtn" class="secondary">Refresh</button>

          <div class="help">
            <div style="font-weight: 700">按钮说明（中文）</div>
            <ul class="muted">
              <li><b>Sleep</b>：发送 <code>/sleep</code>，记录“现在”为入睡时间。</li>
              <li><b>Wake</b>：发送 <code>/wake</code>，记录“现在”为起床时间。</li>
              <li><b>Backfill Sleep…</b>：补记入睡时间，会发送 <code>/sleep YYYY-MM-DD HH:MM backfill</code>（默认当前北京时间，可手动改）。</li>
              <li><b>Backfill Wake…</b>：补记起床时间，会发送 <code>/wake YYYY-MM-DD HH:MM backfill</code>（默认当前北京时间，可手动改）。</li>
              <li><b>Undo</b>：发送 <code>/undo</code>，撤销最近一次 sleep/wake（仅限最近 10 分钟内）。</li>
              <li><b>Rebuild</b>：发送 <code>/rebuild</code>，从事件日志重建表格（当你怀疑表格显示不对/被手动改坏时使用）。</li>
              <li><b>Archive</b>：发送 <code>/archive</code>，封存并关闭当前日志 issue（之后可新建新的日志）。</li>
              <li><b>Refresh</b>：重新拉取最新评论与 Issue Body（表格），用于查看 bot 更新结果。</li>
            </ul>
          </div>

          <div class="muted" style="margin-top: 10px">
            提示：<code>/archive</code> 会关闭当前 issue（不可用 <code>/undo</code> 撤销）。误操作可手动 Reopen。
          </div>
        </div>
      </div>

      <div class="card" id="commentsCard" style="display: none">
        <div class="row">
          <div style="font-weight: 700">最新评论（含 bot）</div>
          <div class="muted" id="commentsMeta"></div>
        </div>
        <pre id="commentsPre"></pre>
      </div>

      <div class="card" id="tableCard" style="display: none">
        <div class="row">
          <div style="font-weight: 700">Issue Body（含表格）</div>
          <div class="muted">（原样显示；你也可以点上面的 issue 链接去 GitHub 看渲染效果）</div>
        </div>
        <pre id="bodyPre"></pre>
      </div>
    </main>

    <script src="./config.js"></script>
    <script>
      const cfg = window.__SLEEP_CHECKIN_CONFIG__ || {};
      const repo = cfg.REPO;
      const workerBase = cfg.WORKER_BASE_URL;

      const $ = (id) => document.getElementById(id);

      $("repoPill").textContent = repo || "(repo not set)";
      $("workerUrl").value = workerBase || "";

      function mustConfig() {
        if (!repo || !workerBase || workerBase.includes("REPLACE_ME")) {
          $("loginHint").textContent = "请先编辑 docs/config.js：设置 WORKER_BASE_URL（你的 Cloudflare Worker 地址）。";
          $("loginBtn").disabled = true;
          return false;
        }
        $("loginHint").textContent = "";
        $("loginBtn").disabled = false;
        return true;
      }

      mustConfig();

      function setAuthState(text) {
        $("authState").textContent = text;
      }

      // ---- time helpers (Beijing, ASCII-only) ----
      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function beijingNowYmdHm() {
        const now = new Date(Date.now() + 8 * 60 * 60 * 1000);
        const y = now.getUTCFullYear();
        const m = pad2(now.getUTCMonth() + 1);
        const d = pad2(now.getUTCDate());
        const hh = pad2(now.getUTCHours());
        const mm = pad2(now.getUTCMinutes());
        return `${y}-${m}-${d} ${hh}:${mm}`;
      }

      function formatBeijing(iso) {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return String(iso || "");
        const bj = new Date(d.getTime() + 8 * 60 * 60 * 1000);
        const y = bj.getUTCFullYear();
        const m = pad2(bj.getUTCMonth() + 1);
        const day = pad2(bj.getUTCDate());
        const hh = pad2(bj.getUTCHours());
        const mm = pad2(bj.getUTCMinutes());
        const ss = pad2(bj.getUTCSeconds());
        return `${y}-${m}-${day} ${hh}:${mm}:${ss} (UTC+8)`;
      }

      // Yesterday date by cutoff=04:00 UTC+8:
      // if now < 04:00, "yesterday" is actually 2 days ago; else it's previous day.
      function beijingYesterdayYmdByCutoff4() {
        const nowBj = new Date(Date.now() + 8 * 60 * 60 * 1000);
        const hh = nowBj.getUTCHours();
        const offsetDays = hh < 4 ? 2 : 1;
        const y = nowBj.getUTCFullYear();
        const m = nowBj.getUTCMonth(); // 0-based
        const d = nowBj.getUTCDate();
        const date = new Date(Date.UTC(y, m, d - offsetDays, 0, 0, 0));
        const yy = date.getUTCFullYear();
        const mm = pad2(date.getUTCMonth() + 1);
        const dd = pad2(date.getUTCDate());
        return `${yy}-${mm}-${dd}`;
      }

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      async function api(path, opts = {}) {
        const res = await fetch(workerBase + path, {
          ...opts,
          headers: {
            "Content-Type": "application/json",
            ...(opts.headers || {}),
          },
        });
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`API ${path} failed: ${res.status} ${t}`);
        }
        return res.json();
      }

      async function ensureSession() {
        const sid = localStorage.getItem("sleepcheckin_session");
        if (!sid) return null;
        return sid;
      }

      function setHasIssueUI(hasIssue) {
        $("noIssueActions").style.display = hasIssue ? "none" : "block";
        $("hasIssueActions").style.display = hasIssue ? "block" : "none";

        $("commentsCard").style.display = hasIssue ? "block" : "none";
        $("tableCard").style.display = hasIssue ? "block" : "none";
      }

      // ---- Leaderboard ----
      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function renderLbRow(rank, item) {
        const user = item?.user || "";
        const dur = item?.duration || "";
        const sleepAt = item?.sleep || "";
        const wakeAt = item?.wake || "";
        const issueUrl = item?.issue_url || "";
        const userUrl = item?.user_url || (user ? `https://github.com/${user}` : "");
        const userHtml = userUrl
          ? `<a target="_blank" rel="noreferrer" href="${escapeHtml(userUrl)}">@${escapeHtml(user)}</a>`
          : `@${escapeHtml(user)}`;
        const issueHtml = issueUrl
          ? `<a target="_blank" rel="noreferrer" href="${escapeHtml(issueUrl)}">issue</a>`
          : "";

        return `<tr>
          <td class="mono">${rank}</td>
          <td>${userHtml} ${issueHtml ? `<span class="muted">(${issueHtml})</span>` : ""}</td>
          <td class="mono">${escapeHtml(sleepAt)}</td>
          <td class="mono">${escapeHtml(wakeAt)}</td>
          <td class="mono">${escapeHtml(dur)}</td>
        </tr>`;
      }

      function renderLeaderboard(data) {
        const date = data?.date || beijingYesterdayYmdByCutoff4();
        $("lbTitle").textContent = `昨日榜单（${date}）`;
        $("lbMeta").textContent = data?.generated_at ? `generated: ${data.generated_at}` : "";

        const sections = [
          { key: "latest_sleep", title: "最晚睡（Top 5）" },
          { key: "earliest_wake", title: "最早起（Top 5）" },
          { key: "longest_sleep", title: "睡得最长（Top 5）" },
          { key: "shortest_sleep", title: "睡得最短（Top 5）" },
        ];

        const htmlParts = [];

        for (const sec of sections) {
          const list = data?.[sec.key] || [];
          htmlParts.push(`<div style="margin-top: 12px">
            <div style="font-weight:700">${escapeHtml(sec.title)}</div>
            ${
              list.length
                ? `<table class="lb">
                    <thead>
                      <tr>
                        <th style="width:40px">#</th>
                        <th>User</th>
                        <th>Sleep</th>
                        <th>Wake</th>
                        <th>Duration</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${list.map((it, i) => renderLbRow(i + 1, it)).join("")}
                    </tbody>
                  </table>`
                : `<div class="muted" style="margin-top:8px">暂无数据</div>`
            }
          </div>`);
        }

        $("lbBody").innerHTML = htmlParts.join("\n");
      }

      async function loadLeaderboard() {
        const ymd = beijingYesterdayYmdByCutoff4();
        $("lbTitle").textContent = `昨日榜单（${ymd}）`;
        $("lbMeta").textContent = "";
        $("lbBody").textContent = "Loading…";

        try {
          const res = await fetch(`./leaderboard-latest.json?_=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          renderLeaderboard(data);
        } catch (err) {
          $("lbBody").innerHTML =
            `<div class="muted">暂无榜单或加载失败。` +
            `（通常是每日任务尚未生成 <code>docs/leaderboard-latest.json</code>）</div>`;
        }
      }

      $("lbRefreshBtn").addEventListener("click", async () => {
        await loadLeaderboard();
      });

      // ---- Issue UI ----
      async function loadMeAndIssue() {
        const sid = await ensureSession();
        if (!sid) {
          setAuthState("Not logged in");
          $("issueCard").style.display = "none";
          setHasIssueUI(false);
          return;
        }

        setAuthState("Loading…");
        const me = await api(`/me?session=${encodeURIComponent(sid)}`);
        setAuthState(`@${me.login}`);

        const issue = await api(`/find-issue?session=${encodeURIComponent(sid)}`);

        $("issueCard").style.display = "block";

        if (!issue || !issue.number) {
          $("issueStatus").textContent = "未找到 open 的 sleep-log issue";
          $("issueLink").innerHTML = `
            <div class="muted">你还没有 Sleep Log issue。</div>
            <div class="muted">你可以点下面按钮自动创建（推荐），或者去 GitHub 用模板手动创建。</div>
          `;
          setHasIssueUI(false);
          return;
        }

        $("issueStatus").textContent = `#${issue.number}`;
        $("issueLink").innerHTML = `<a target="_blank" rel="noreferrer" href="${issue.html_url}">${issue.title}</a>`;

        setHasIssueUI(true);
        await refreshIssueViews(issue.number);
      }

      async function refreshIssueViews(issueNumber) {
        const sid = await ensureSession();
        const data = await api(`/issue-data?session=${encodeURIComponent(sid)}&number=${issueNumber}&_=${Date.now()}`);

        $("commentsMeta").textContent = `${data.comments.length} comments (showing latest 20)`;
        $("commentsPre").textContent = data.comments
          .map((c) => {
            const who = c.user_login;
            const at = formatBeijing(c.created_at);
            return `[${at}] ${who}:\n${c.body}\n\n---\n`;
          })
          .join("\n");

        $("bodyPre").textContent = data.issue_body || "";
      }

      async function postCommand(cmd) {
        const sid = await ensureSession();
        if (!sid) return alert("请先登录");

        const issue = await api(`/find-issue?session=${encodeURIComponent(sid)}`);
        if (!issue?.number) {
          alert("未找到 open 的 sleep-log issue");
          return;
        }

        await api(`/comment?session=${encodeURIComponent(sid)}`, {
          method: "POST",
          body: JSON.stringify({ number: issue.number, body: cmd }),
        });

        // wait for bot to update a bit, then refresh
        await sleep(1200);
        await refreshIssueViews(issue.number);
      }

      async function createSleepLogIssue() {
        const sid = await ensureSession();
        if (!sid) return alert("请先登录");

        $("createIssueBtn").disabled = true;
        $("createIssueBtn").textContent = "Creating…";
        try {
          const created = await api(`/create-issue?session=${encodeURIComponent(sid)}`, {
            method: "POST",
            body: JSON.stringify({}),
          });

          if (!created?.number) {
            alert("创建失败：未返回 issue number");
            return;
          }

          $("issueStatus").textContent = `#${created.number}`;
          $("issueLink").innerHTML = `<a target="_blank" rel="noreferrer" href="${created.html_url}">${created.title}</a>`;

          setHasIssueUI(true);

          // Wait a bit for /rebuild to be processed, then refresh a couple of times.
          await sleep(1200);
          await refreshIssueViews(created.number);
          await sleep(1200);
          await refreshIssueViews(created.number);
        } catch (err) {
          alert(err.message || String(err));
        } finally {
          $("createIssueBtn").disabled = false;
          $("createIssueBtn").textContent = "Create Issue";
        }
      }

      $("loginBtn").addEventListener("click", () => {
        if (!mustConfig()) return;
        window.location.href = workerBase + "/login";
      });

      $("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("sleepcheckin_session");
        setAuthState("Not logged in");
        loadMeAndIssue();
      });

      $("refreshBtn").addEventListener("click", async () => {
        await loadMeAndIssue();
      });

      $("createIssueBtn").addEventListener("click", async () => {
        await createSleepLogIssue();
      });

      $("backfillSleepBtn").addEventListener("click", async () => {
        const def = beijingNowYmdHm();
        const input = prompt("输入 Sleep 时间（北京时间）格式：YYYY-MM-DD HH:MM\n留空则使用当前时间", def);
        if (input === null) return;
        const when = String(input).trim() || def;
        await postCommand(`/sleep ${when} backfill`);
      });

      $("backfillWakeBtn").addEventListener("click", async () => {
        const def = beijingNowYmdHm();
        const input = prompt("输入 Wake 时间（北京时间）格式：YYYY-MM-DD HH:MM\n留空则使用当前时间", def);
        if (input === null) return;
        const when = String(input).trim() || def;
        await postCommand(`/wake ${when} backfill`);
      });

      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-cmd]");
        if (!btn) return;

        const cmd = btn.getAttribute("data-cmd");
        btn.disabled = true;
        try {
          await postCommand(cmd);
        } catch (err) {
          alert(err.message || String(err));
        } finally {
          btn.disabled = false;
        }
      });

      (function initFromQuery() {
        const u = new URL(window.location.href);
        const session = u.searchParams.get("session");
        if (session) {
          localStorage.setItem("sleepcheckin_session", session);
          u.searchParams.delete("session");
          window.history.replaceState({}, "", u.toString());
        }
      })();

      // init
      loadLeaderboard();
      loadMeAndIssue();
    </script>
  </body>
</html>
